<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PoppyChat + Viberverse</title>
<style>
body{background:#0b1020;color:#e7e9ee;font-family:system-ui;padding:0;margin:0;}
header{background:#0f162e;padding:16px;display:flex;justify-content:space-between;align-items:center;}
.card{background:#121a36;padding:16px;margin:16px;border-radius:12px;}
.hidden{display:none;}
input,textarea,select,button{width:100%;margin-top:6px;padding:8px;border-radius:8px;background:#0c1329;color:#e7e9ee;border:1px solid #2a3766;}
button{cursor:pointer;}
.muted{color:#a9b3d1;font-size:13px;}
#chatMessages{height:300px;overflow:auto;border:1px solid #2a3766;padding:8px;margin-top:6px;border-radius:8px;background:#0c1329;}
</style>
</head>
<body>
<header>
<h1>PoppyChat</h1>
<div id="whoami" class="muted">Not signed in</div>
</header>

<!-- Login Card -->
<div class="card" id="loginCard">
<h2>Sign In</h2>
<label>Username</label><input id="loginUser" autocomplete="username">
<label>Password</label><input id="loginPass" type="password" autocomplete="current-password">
<button id="loginBtn">Sign In</button>
<div id="loginMsg" class="muted"></div>
</div>

<!-- Main Menu -->
<div class="card hidden" id="menuCard">
<h2>Main Menu</h2>
<button data-open="#pmCard">Private Messages</button>
<button data-open="#groupsCard">Groups</button>
</div>

<!-- PM Card -->
<div class="card hidden" id="pmCard">
<h3>Private Messages</h3>
<label>Recipient</label><input id="pmTo">
<label>Message</label><textarea id="pmText"></textarea>
<button id="pmSendBtn">Send</button>
<div id="pmSendMsg" class="muted"></div>
<div id="chatMessages"></div>
</div>

<!-- Groups Card -->
<div class="card hidden" id="groupsCard">
<h3>Groups</h3>
<p>Groups functionality coming soon.</p>
</div>

<script>
// ===== CONFIG =====
const API_BASE = 'https://popychat-backend.onrender.com'; // <-- Replace with your Render URL
let currentUser = '';

// ===== LOGIN =====
document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('loginUser').value;
    const password = document.getElementById('loginPass').value;

    const res = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username,password})
    });
    const data = await res.json();
    const msg = document.getElementById('loginMsg');
    if(data.ok){
        msg.textContent = 'Signed in successfully!';
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('menuCard').classList.remove('hidden');
        document.getElementById('whoami').textContent = username + ' (' + data.role + ')';
        currentUser = username;
    } else {
        msg.textContent = data.msg;
    }
});

// ===== NAV BUTTONS =====
document.querySelectorAll('#menuCard button').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
        document.getElementById('menuCard').classList.remove('hidden');
        const target = document.querySelector(btn.dataset.open);
        if(target) target.classList.remove('hidden');
    });
});

// ===== SEND PM =====
document.getElementById('pmSendBtn').addEventListener('click', async ()=>{
    const to = document.getElementById('pmTo').value;
    const text = document.getElementById('pmText').value;
    const res = await fetch(`${API_BASE}/sendPM`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({from:currentUser,to,text})
    });
    const data = await res.json();
    const msg = document.getElementById('pmSendMsg');
    if(data.ok){
        msg.textContent = 'Message sent!';
        document.getElementById('pmText').value = '';
        loadInbox();
    } else {
        msg.textContent = data.msg;
    }
});

// ===== LOAD INBOX =====
async function loadInbox(){
    if(!currentUser) return;
    const res = await fetch(`${API_BASE}/inbox/${currentUser}`);
    const data = await res.json();
    const chatBox = document.getElementById('chatMessages');
    chatBox.innerHTML = '';
    if(data.ok){
        data.messages.forEach((m,i)=>{
            const div = document.createElement('div');
            div.textContent = `${m.from}: ${m.text}`;
            chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

// Poll inbox every 3 seconds
setInterval(loadInbox,3000);
</script>
</body>
</html>
